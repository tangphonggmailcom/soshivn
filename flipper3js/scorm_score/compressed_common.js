/*! flipper-scorm-score */
this.flipperjs=this.flipperjs||{},function(a){var b=function(){this.thisName="MonitorPageInfo"},c=b.prototype;c.pageNo=0,c.startDate=null,c.endDate=null,c.sumSec=0,c.tmpSumSec=0,c.browsedFlg=!1,flipperjs.MonitorPageInfo=b}(window),function(a){var b=function(){this.thisName="MonitorPageInfoManager"},c=b.prototype;c._browsedPageSec=10,c._completedRate=50,c._browsedPageSec_lms=-1,c._completedRate_lms=-1,c._totalPageNum=0,c._monitorPagesInfoList=[],c._currentPagesInfoList=[],c._sumBrowseSecFlg=!1,c._timerId,c.setBrowsedPageSec=function(a){this._browsedPageSec=a},c.setCompletedRate=function(a){this._completedRate=a},c.getBrowsedPageSec=function(){return this._browsedPageSec_lms>=0?this._browsedPageSec_lms:this._browsedPageSec},c.getCompletedRate=function(){return this._completedRate_lms>=0?this._completedRate_lms:this._completedRate},c.setLaunchDataFromLMS=function(a){if(""!=a)try{var b=$.parseJSON(a);null!=b&&(b.hasOwnProperty("browsedPageSec")&&(this._browsedPageSec_lms=Number(b.browsedPageSec)),b.hasOwnProperty("completedRate")&&(this._completedRate_lms=Number(b.completedRate)))}catch(c){alert("JSON parsing error [launchData]\n"+c.message)}},c.setTotalPageNum=function(a){this._totalPageNum=a;for(var b=this._monitorPagesInfoList.length,c=1;a>=c;c++)if(c>b){var d=new flipperjs.MonitorPageInfo;d.pageNo=c,this._monitorPagesInfoList.push(d)}return this.getCompletedStatus()},c._searchMonitorPagesInfo=function(a){var b=this._monitorPagesInfoList.length;if(b>=a){var c=this._monitorPagesInfoList[a-1];return c}return null},c.startMonitorPages=function(a){if(!(null==a||a.length<=0)){var b=!1;for(i=0;i<a.length;i++){var c=a[i],d=this._searchMonitorPagesInfo(c);null!=d&&(d.startDate=new Date,this._currentPagesInfoList.push(d),d.browsedFlg||(b=!0))}b&&this._startCheckTimer()}},c._startCheckTimer=function(){this._stopCheckTimer(),this._timerId=setTimeout(jQuery.proxy(this._onCompletedBrowsedPage,this),1e3*this.getBrowsedPageSec())},c._stopCheckTimer=function(){null!=this._timerId&&clearTimeout(this._timerId)},c._onCompletedBrowsedPage=function(){var a=[];for(var b in this._currentPagesInfoList){var c=this._currentPagesInfoList[b];c.browsedFlg=!0,a.push(c.pageNo)}this.onCompletedBrowsedPage(a)},c.onCompletedBrowsedPage=function(a){},c.finishContent=function(){for(var a in this._currentPagesInfoList){var b=this._currentPagesInfoList[a];if(null!=b&&(b.endDate=new Date,null!=b.startDate)){var c=0;(null==b.startDate||null==b.endDate)&&(c=0);var d=b.endDate.getTime()-b.startDate.getTime();c=Math.floor(d/1e3),b.sumSec+=c}}},c.endMonitorPages=function(a){if(!(null==a||a.length<=0))for(this._stopCheckTimer(),i=0;i<a.length;i++){var b=a[i],c=this._searchMonitorPagesInfo(b);if(null!=c){if(c.endDate=new Date,null!=c.startDate){var d=0;(null==c.startDate||null==c.endDate)&&(d=0);var e=c.endDate.getTime()-c.startDate.getTime();d=Math.floor(e/1e3),c.sumSec+=d;var f;f=this._sumBrowseSecFlg?c.sumSec:d,!c.browsedFlg&&f>=this.getBrowsedPageSec()&&(c.browsedFlg=!0)}c.startDate=null,c.endDate=null,this._currentPagesInfoList=[]}}},c.getCompletedStatus=function(){for(var a=this._monitorPagesInfoList.length,b=0,c=0;a>c;c++){var d=this._monitorPagesInfoList[c];d.browsedFlg&&b++}if(this._totalPageNum<=0)return!1;var e=0;return this.getCompletedRate()>0?(e=this.getCompletedRate()/100*this._totalPageNum,b>=e?!0:!1):!0},c.getBrowsedPagesData=function(){for(var a="",b=this._monitorPagesInfoList.length,c=0;b>c;c++){var d=this._monitorPagesInfoList[c];c>0&&(a+=","),a+=d.browsedFlg?"1":"0"}return a},c.getViewSecData=function(){for(var a="",b=this._monitorPagesInfoList.length,c=0;b>c;c++){var d=this._monitorPagesInfoList[c];c>0&&(a+=","),a+=d.sumSec}return a},c.getSuspendData=function(){for(var a="",b="",c=this._monitorPagesInfoList.length,d=0;c>d;d++){var e=this._monitorPagesInfoList[d];d>0&&(a+=",",b+=","),a+=e.browsedFlg?"1":"0",b+=e.sumSec}return this._sumBrowseSecFlg?'{"b":['+a+'],"t":['+b+"]}":a},c.setSuspendData=function(a){var b=[],c=[];if(this._sumBrowseSecFlg){try{var d=$.parseJSON(a)}catch(e){alert("JSON parsing error [suspendData]\n"+e.message)}d.hasOwnProperty("b")&&(b=d.b),d.hasOwnProperty("t")&&(c=d.t)}else null!=a&&""!=a&&(b=a.split(","));for(var f=Math.max(b.length,c.length),g=0;f>g;g++){var h;g>=this._monitorPagesInfoList.length-1?(h=new flipperjs.MonitorPageInfo,h.pageNo=g+1,this._monitorPagesInfoList.push(h)):h=this._monitorPagesInfoList[g],g<c.length&&(h.sumSec=Number(c[g])),g<b.length&&("1"==b[g]?h.browsedFlg=!0:h.browsedFlg=!1)}},flipperjs.MonitorPageInfoManager=b}(window),this.flipperjs=this.flipperjs||{},function(a){var b=function(){this.thisName="ScoreSettingData"},c=b.prototype;c.managerId="",c.contentId="",c.contentTitle="",c.contentUrl="",c.gaeUrl_pcId="",c.gaeUrl="",c.userInfo="",c.userInfoMandatory=!1,c.userInfoMessage="",c.browsedPageSec=10,c.completedRate=90,flipperjs.ScoreSettingData=b}(window),function(a){var b=function(){this.thisName="ScormAndScoreController",this._monitorPageMng=new flipperjs.MonitorPageInfoManager,this._monitorPageMng.onCompletedBrowsedPage=jQuery.proxy(this._onCompletedBrowsedPage,this)},c=b.prototype;c.KIND_SCORE="score",c.KIND_SCORM_12="1.2",c.KIND_SCORM_2004="2004",c._kind="1.2",c._option="",c._monitorPageMng,c._launch_data,c._lastPageNo=0,c._suspendData="",c._completedContent=!1,c._scormCtrl,c._scoreCtrl,c.init=function(a,b){this._kind=a,""==b||null==b?this._init():this._loadSettingXml(b)},c.setData=function(a,b){switch(a){case"totalPageNum":this._completedContent=this._monitorPageMng.setTotalPageNum(b),this._kind==this.KIND_SCORE?this._completedContent&&!this._scoreCtrl.getSendFlg()&&this.sendCompletedContentStatus():this._completedContent&&(this._onCompletedContent(),this._commit());break;case"browsedPageSec":this._monitorPageMng.setBrowsedPageSec(b);break;case"completedRate":this._monitorPageMng.setCompletedRate(b)}},c.getData=function(a){var b=null;switch(a){case"lastPageNo":b=this._lastPageNo;break;case"suspendData":b=this._suspendData}return b},c.startDisplayPage=function(a){this._setCurrentPage(a),this._monitorPageMng.startMonitorPages(a)},c.endDisplayPage=function(a){this._monitorPageMng.endMonitorPages(a);var b=this._monitorPageMng.getViewSecData();this._setBrowseSecInfo(b)},c.onCompletedBrowsedPage=function(a){},c.onCompletedContent=function(a){},c.onInitialized=function(){},c.getInitializedFlg=function(){return this._kind==this.KIND_SCORE?this._scoreCtrl.getInitializedFlg():this._scormCtrl.getInitializedFlg()},c.confirmMoveLastPage=function(a,b){var c="前回最後に表示していた&1ページを表示しますか？";return void 0!=a&&null!=a&&""!=a&&(c=a),c=c.replace("&1",b),confirm(c)?!0:(this._setCurrentPage([b]),!1)},c.sendCompletedContentStatus=function(){this._kind==this.KIND_SCORE&&this._scoreCtrl.sendData("completed")},c._loadSettingXml=function(a){var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){b._onCompleteLoadSettingXml(a)},error:function(a){alert("Error Load XML")}})},c._onCompleteLoadSettingXml=function(a){var b=this._parseSettingXml(a);this._option=b,this._init()},c._parseSettingXml=function(a){var b=new flipperjs.ScoreSettingData;b.managerId=$(a).find("managerId").text(),b.contentId=$(a).find("contentId").text(),b.contentTitle=$(a).find("contentTitle").text();var c=[location.protocol,"//",location.host,location.pathname].join(""),d=c.split("/");d.splice(d.length-1,1),"m"==d[d.length-1]&&d.splice(d.length-1,1),b.contentUrl=d.join("/")+"/",b.gaeUrl_pcId=$(a).find("pcIdUrl").text(),b.gaeUrl=$(a).find("gaeUrl").text();var e=$(a).find("browsedPageSec").text();""!=e&&null!=e&&(b.browsedPageSec=Number(e));var f=$(a).find("completedRate").text();""!=f&&null!=f&&(b.completedRate=Number(f));var g=this._getRequest();if(null==g)b.userInfo="";else if(g.u)try{var h=decodeURIComponent(g.u);b.userInfo=h}catch(i){b.userInfo=""}else b.userInfo="";return b},c._getRequest=function(){if(location.search.length>1){for(var a=new Object,b=location.search.substr(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");a[d[0]]=d[1]}return a}return null},c._init=function(){this._monitorPageMng.setBrowsedPageSec(this._option.browsedPageSec),this._monitorPageMng.setCompletedRate(this._option.completedRate),this._kind==this.KIND_SCORE?(this._scoreCtrl=new flipperjs.ScoreController,this._scoreCtrl.onInitialized=jQuery.proxy(this._onInitialized,this),this._scoreCtrl.onCompletedSendPost=jQuery.proxy(this._onCompletedSendPost,this),this._scoreCtrl.init(this._kind,this._option)):(this._scormCtrl=new flipperjs.ScormController,this._scormCtrl.onInitialized=jQuery.proxy(this._onInitialized,this),scormPreFinish=jQuery.proxy(this._finish,this),this._scormCtrl.init(this._kind))},c._onInitialized=function(a,b,c){this._lastPageNo=a,this._suspendData=b,""!=this._suspendData&&this._monitorPageMng.setSuspendData(this._suspendData),this._launch_data=c,this._monitorPageMng.setLaunchDataFromLMS(this._launch_data);var d=this;setTimeout(function(){d.onInitialized()},100)},c._setCurrentPage=function(a){if(!(null==a||a.length<=0)){var b=a[a.length-1],c="lesson_location";this._kind==this.KIND_SCORE?this._scoreCtrl.setValue(c,b):this._scormCtrl.setValue(c,b),this._commit()}},c._onCompletedBrowsedPage=function(a){this._suspendData=this._monitorPageMng.getSuspendData(),this._setSuspendData(this._suspendData);var b=this._monitorPageMng.getCompletedStatus();b&&this._completedContent!=b&&(this._completedContent=b,this._onCompletedContent()),this._commit(),this.onCompletedBrowsedPage(a)},c._onCompletedContent=function(){if(this._kind==this.KIND_SCORE)this.sendCompletedContentStatus();else{var a="lesson_status";this._scormCtrl.setValue(a,"completed")}},c._setSuspendData=function(a){var b="suspend_data";this._kind==this.KIND_SCORE?this._scoreCtrl.setValue(b,a):this._scormCtrl.setValue(b,a)},c._setBrowseSecInfo=function(a){if(this._kind!=this.KIND_SCORE){var b="cmi.comments";this._scormCtrl.setValue(b,a)}},c._commit=function(){this._kind!=this.KIND_SCORE&&this._scormCtrl.commit()},c._finish=function(){if(this._monitorPageMng.finishContent(),this._kind!=this.KIND_SCORE){var a=this._monitorPageMng.getViewSecData();this._setBrowseSecInfo(a)}},c.sendLog=function(a){modelName="cmi.comments",this._scormCtrl.setValue(modelName,a)},c._onCompletedSendPost=function(a){a.result+"/"+a.message;this.onCompletedContent(a.result)},flipperjs.ScormAndScoreController=b}(window);